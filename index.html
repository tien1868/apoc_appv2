<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>APOC¬≤ ¬∑ Garment Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#0d0f12;--surf:#13161b;--surf2:#191c22;--surf3:#1f232b;
      --bdr:rgba(255,255,255,0.07);--bdr-h:rgba(255,255,255,0.12);
      --amber:#e8924a;--amber-d:rgba(232,146,74,0.14);--amber-g:rgba(232,146,74,0.06);--amber-b:rgba(232,146,74,0.28);
      --green:#3ecf8e;--green-d:rgba(62,207,142,0.12);--green-b:rgba(62,207,142,0.28);
      --red:#e05c5c;--red-d:rgba(224,92,92,0.12);
      --blue:#5b9cf6;--blue-d:rgba(91,156,246,0.12);
      --text:#e8e5e0;--t2:#7a7875;--t3:#3d3c3a;
      --r:8px;
    }
    html{font-size:14px}
    body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;line-height:1.5;min-height:100vh}
    body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:9999;
      background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");opacity:.5}

    .page{max-width:860px;margin:0 auto;padding:0 24px 80px}

    /* HEADER */
    header{display:flex;align-items:center;justify-content:space-between;padding:26px 0;border-bottom:1px solid var(--bdr);margin-bottom:28px}
    .logo-main{display:flex;align-items:baseline;gap:2px}
    .logo-text{font-size:24px;font-weight:800;letter-spacing:-.04em}
    .logo-sup{font-size:13px;font-weight:700;color:var(--amber);vertical-align:super;line-height:0}
    .logo-sub{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:.14em;text-transform:uppercase;margin-top:4px}
    .hdr-meta{font-family:'DM Mono',monospace;font-size:10px;text-align:right;line-height:2}

    /* CARDS */
    .card{background:var(--surf);border:1px solid var(--bdr);border-radius:12px;margin-bottom:14px;overflow:hidden;transition:border-color .2s}
    .card.active{border-color:var(--amber-b)}
    .card.done{border-color:var(--green-b)}
    .card.ebay-card{border-color:rgba(91,156,246,.22)}
    .card.ebay-card.linked{border-color:var(--green-b)}
    .card-hd{display:flex;align-items:center;gap:12px;padding:18px 22px;border-bottom:1px solid var(--bdr)}
    .card-icon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-family:'DM Mono',monospace;flex-shrink:0;background:var(--surf2);border:1px solid var(--bdr-h);color:var(--t2)}
    .card.active .card-icon{background:var(--amber-d);border-color:var(--amber-b);color:var(--amber)}
    .card.done .card-icon{background:var(--green-d);border-color:var(--green-b);color:var(--green)}
    .card.ebay-card .card-icon{background:var(--blue-d);border-color:rgba(91,156,246,.28);color:var(--blue)}
    .card.ebay-card.linked .card-icon{background:var(--green-d);border-color:var(--green-b);color:var(--green)}
    .card-title{font-size:14px;font-weight:700;flex:1}
    .card-badge{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--t3);padding:3px 8px;border-radius:4px;background:var(--surf2);border:1px solid var(--bdr)}
    .card-body{padding:22px}

    /* EBAY */
    .ebay-connect-row{display:flex;flex-wrap:wrap;align-items:center;gap:14px;padding:16px 18px;background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);margin-bottom:16px}
    .ebay-icon-box{width:42px;height:42px;border-radius:8px;background:var(--blue-d);border:1px solid rgba(91,156,246,.28);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
    .ebay-info{flex:1}
    .ebay-info-title{font-size:13px;font-weight:700;margin-bottom:2px}
    .ebay-info-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2)}
    .ebay-connect-btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:12px 18px;border-radius:var(--r);background:var(--blue);border:1px solid var(--blue);color:#000;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;width:100%;text-decoration:none}
    .ebay-connect-btn:hover{background:#7ab3ff;box-shadow:0 4px 16px rgba(91,156,246,.25);transform:translateY(-1px)}
    .ebay-complete-btn{display:inline-flex;align-items:center;gap:7px;padding:10px 18px;border-radius:var(--r);background:var(--surf2);border:1px solid var(--bdr-h);color:var(--t2);font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
    .ebay-complete-btn:hover{background:var(--surf3);color:var(--text)}
    .connected-badge{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--green-d);border:1px solid var(--green-b);border-radius:var(--r);font-family:'DM Mono',monospace;font-size:11px;color:var(--green);margin-bottom:16px}
    .e-dot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0;box-shadow:0 0 6px currentColor;animation:blink 2.5s infinite}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    .g3{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .g2{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}

    /* FORM */
    .lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:var(--t3);margin-bottom:7px;display:block}
    .f-sel,.f-inp,.f-text{width:100%;background:var(--surf2);border:1px solid var(--bdr-h);border-radius:var(--r);padding:10px 12px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .15s;-webkit-appearance:none}
    .f-sel:focus,.f-inp:focus,.f-text:focus{border-color:var(--amber-b)}
    .f-sel{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%233d3c3a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
    .f-text{resize:vertical;min-height:72px;line-height:1.7}
    .f-inp.mono{font-family:'DM Mono',monospace;letter-spacing:.1em}

    /* ZIP */
    .zip-wrap{position:relative;display:flex;align-items:center;gap:8px}
    .zip-status{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.06em;transition:all .3s}

    /* UPLOAD */
    .drop-zone{border:1.5px dashed var(--bdr-h);border-radius:var(--r);min-height:170px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;transition:all .2s}
    .drop-zone:hover,.drop-zone.over{border-color:rgba(232,146,74,.5);background:var(--amber-g)}
    .drop-zone.filled{border-style:solid;border-color:var(--amber-b);min-height:auto;padding:14px;align-items:flex-start;justify-content:flex-start}
    .up-ico{width:44px;height:44px;border:1.5px solid var(--bdr-h);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--t3);font-size:18px}
    .up-title{font-size:14px;font-weight:700;margin-bottom:3px;text-align:center}
    .up-sub{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);letter-spacing:.04em;text-align:center}
    .img-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:100%}
    .img-cell{aspect-ratio:3/4;border-radius:6px;border:1px solid var(--bdr);overflow:hidden;position:relative;background:var(--surf2)}
    .img-cell img{width:100%;height:100%;object-fit:cover;display:block}
    .img-cell .del{position:absolute;top:5px;right:5px;width:20px;height:20px;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.12);border-radius:50%;color:var(--t2);font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s}
    .img-cell:hover .del{opacity:1}
    .img-add{aspect-ratio:3/4;border-radius:6px;border:1.5px dashed var(--bdr-h);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--t3);font-size:16px;transition:all .15s}
    .img-add:hover{border-color:var(--amber);color:var(--amber)}
    .act-row{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}

    /* BUTTONS */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 18px;border-radius:var(--r);border:1px solid var(--bdr-h);background:var(--surf2);color:var(--t2);font-family:'Syne',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;min-width:0;flex-shrink:1}
    .btn:hover{background:var(--surf3);color:var(--text)}
    .btn.pri{background:var(--amber);border-color:var(--amber);color:#000;flex:1;min-width:160px;letter-spacing:.02em}
    .btn.pri:hover{background:#f0a060;box-shadow:0 4px 18px rgba(232,146,74,.22);transform:translateY(-1px)}
    .btn.pri:active{transform:none}
    .btn.pri:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}
    .btn.pub{background:var(--green);border-color:var(--green);color:#000;width:100%;padding:13px;font-size:14px;font-weight:800}
    .btn.pub:hover{background:#4fe09a;box-shadow:0 4px 18px rgba(62,207,142,.2);transform:translateY(-1px)}
    .btn.pub:disabled{opacity:.4;cursor:not-allowed;transform:none;box-shadow:none}

    /* REPORT */
    .title-box{background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);padding:16px 18px;margin-bottom:12px}
    .title-area{width:100%;background:transparent;border:none;color:var(--text);font-family:'Syne',sans-serif;font-size:17px;font-weight:700;letter-spacing:-.2px;line-height:1.35;resize:none;outline:none}
    .title-area:focus{color:var(--amber)}
    .char-hint{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);margin-top:6px}
    .seo-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
    .seo-tag{font-family:'DM Mono',monospace;font-size:9px;padding:3px 7px;border-radius:3px;border:1px solid rgba(232,146,74,.2);background:var(--amber-g);color:var(--amber)}

    .dbox{background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);padding:15px 16px}
    .dval{font-size:13px;font-weight:500;color:var(--text);line-height:1.6}
    .dval.price{font-size:24px;font-weight:800;color:var(--amber);letter-spacing:-.5px}
    .dval.grn{color:var(--green);font-family:'DM Mono',monospace;font-size:12px}
    .dsub{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);margin-top:5px;line-height:1.7}

    .conf-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--bdr)}
    .conf-row:last-child{border-bottom:none;padding-bottom:0}
    .c-name{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);width:90px;flex-shrink:0}
    .c-track{flex:1;height:3px;background:var(--surf);border-radius:2px;overflow:hidden}
    .c-fill{height:100%;border-radius:2px;transition:width .8s ease}
    .c-fill.hi{background:var(--green)}.c-fill.md{background:var(--amber)}.c-fill.lo{background:var(--red)}
    .c-pct{font-family:'DM Mono',monospace;font-size:10px;width:30px;text-align:right}

    /* SPECIFICS TABLE ‚Äî each row is a form field */
    .specs-wrap{background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;margin-bottom:12px}
    .spec-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));border-bottom:1px solid var(--bdr);align-items:center}
    .spec-row:last-child{border-bottom:none}
    .spec-row.full{grid-template-columns:140px 1fr}
    .spec-k{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--t2);padding:10px 14px;border-right:1px solid var(--bdr)}
    .spec-k.r2{border-left:1px solid var(--bdr)}
    .spec-v{padding:6px 10px}
    .spec-inp{width:100%;background:transparent;border:none;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;outline:none;padding:4px 4px}
    .spec-inp:focus{color:var(--amber)}
    .spec-sel{width:100%;background:transparent;border:none;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;font-weight:500;outline:none;padding:4px 4px;-webkit-appearance:none;cursor:pointer}
    .spec-sel:focus{color:var(--amber)}

    /* tag strip */
    .tag-strip{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .tag{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.06em;text-transform:uppercase;padding:4px 8px;border-radius:4px;border:1px solid var(--bdr);background:var(--surf2);color:var(--t2)}
    .tag.a{border-color:var(--amber-b);background:var(--amber-d);color:var(--amber)}
    .tag.g{border-color:var(--green-b);background:var(--green-d);color:var(--green)}

    /* progress */
    .prog-wrap{background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);padding:18px}
    .prog-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--bdr)}
    .prog-row:last-child{border-bottom:none;padding-bottom:0}
    .prog-n{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);width:18px;flex-shrink:0}
    .prog-name{font-size:13px;font-weight:500;flex:1}
    .prog-s{font-family:'DM Mono',monospace;font-size:10px}
    .prog-s.w{color:var(--t3)}.prog-s.r{color:var(--amber)}.prog-s.d{color:var(--green)}

    .sec-div{height:1px;background:var(--bdr);margin:16px 0}

    .pub-res{margin-top:14px;padding:13px 16px;border-radius:var(--r);font-family:'DM Mono',monospace;font-size:12px;display:none;line-height:1.8;white-space:pre-wrap}
    .pub-res.ok{background:var(--green-d);border:1px solid var(--green-b);color:var(--green);display:block}
    .pub-res.er{background:var(--red-d);border:1px solid rgba(224,92,92,.22);color:var(--red);display:block}

    .save-note{font-family:'DM Mono',monospace;font-size:9px;color:var(--green);letter-spacing:.06em;opacity:0;transition:opacity .3s}
    .save-note.show{opacity:1}

    /* TOGGLE SWITCH */
    .toggle{position:relative;width:36px;height:20px;flex-shrink:0;display:inline-block}
    .toggle input{opacity:0;width:0;height:0;position:absolute}
    .toggle-track{position:absolute;inset:0;background:var(--surf3);border:1px solid var(--bdr-h);border-radius:10px;cursor:pointer;transition:all .2s}
    .toggle-track::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--t2);border-radius:50%;transition:all .2s}
    .toggle input:checked+.toggle-track{background:var(--amber-d);border-color:var(--amber-b)}
    .toggle input:checked+.toggle-track::after{transform:translateX(16px);background:var(--amber)}
    .toggle-label{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);letter-spacing:.06em;text-transform:uppercase;cursor:pointer}

    /* COMPS */
    .comps-scroll{display:flex;gap:10px;overflow-x:auto;padding:8px 0 4px}
    .comp-card{flex:0 0 150px;background:var(--surf2);border:1px solid var(--bdr);border-radius:8px;overflow:hidden;cursor:pointer;transition:border-color .15s}
    .comp-card:hover{border-color:var(--amber-b)}
    .comp-card img{width:100%;height:100px;object-fit:cover;display:block}
    .comp-info{padding:8px}
    .comp-price{font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:var(--amber)}
    .comp-title{font-size:10px;color:var(--t3);margin-top:3px;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .comp-cond{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);margin-top:3px;letter-spacing:.04em;text-transform:uppercase}
    .comps-avg{font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);margin-top:8px}

    /* CROP/ROTATE MODAL */
    .edit-modal{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
    .edit-modal canvas{max-width:90vw;max-height:60vh;border:1px solid var(--bdr-h);border-radius:6px;cursor:crosshair}
    .edit-toolbar{display:flex;gap:10px;margin-top:16px;align-items:center;flex-wrap:wrap;justify-content:center}
    .edit-toolbar .btn{min-width:auto;padding:10px 16px}
    .crop-hint{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);margin-top:8px;letter-spacing:.04em}

    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{display:inline-block;animation:spin .8s linear infinite}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    .fade-in{animation:fadeUp .25s ease forwards}
    *{scrollbar-width:thin;scrollbar-color:var(--surf2) transparent}

    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media(max-width:640px){
      html{font-size:15px}
      .page{padding:0 14px 60px}

      /* header ‚Äî stack logo + meta */
      header{flex-direction:column;align-items:flex-start;gap:8px;padding:18px 0 18px}
      .hdr-meta{text-align:left;font-size:9px}

      /* cards */
      .card-hd{padding:14px 16px}
      .card-body{padding:16px}
      .card-badge{display:none} /* hide small badge on mobile, save space */

      /* eBay connect row ‚Äî stack vertically */
      .ebay-connect-row{flex-direction:column;align-items:flex-start;gap:12px;padding:14px}
      .ebay-connect-btn{width:100%;justify-content:center;padding:13px}
      .ebay-complete-btn{width:100%;justify-content:center;padding:12px}

      /* all grids collapse to single column */
      .g2,.g3{grid-template-columns:1fr}

      /* action buttons ‚Äî stack, full width */
      .act-row{flex-direction:column}
      .act-row .btn{width:100%;padding:13px}
      .btn.pri{flex:none}

      /* image grid ‚Äî 3 columns on mobile (easier to tap) */
      .img-grid{grid-template-columns:repeat(3,1fr)}

      /* always show delete button on mobile (no hover) */
      .img-cell .del{opacity:1;width:24px;height:24px;font-size:11px}

      /* drop zone shorter on mobile */
      .drop-zone{min-height:130px}
      .up-title{font-size:13px}

      /* item specifics ‚Äî 2-col grid wraps all 4 items into 2 rows on mobile */
      .specs-wrap .spec-row{display:grid;grid-template-columns:100px 1fr;border-bottom:1px solid var(--bdr)}
      .spec-k{border-right:none!important;border-left:none!important;padding:8px 12px}
      .spec-k.r2{border-left:none!important;border-top:1px solid var(--bdr)}
      .spec-v{padding:6px 10px}

      /* title font smaller on mobile */
      .title-area{font-size:15px}

      /* confidence rows ‚Äî tighter */
      .c-name{width:70px}

      /* dbox price */
      .dval.price{font-size:20px}

      /* publish button ‚Äî bigger tap target */
      .btn.pub{padding:16px;font-size:15px}

      /* zip input full width */
      .f-inp.mono{max-width:100%!important}

      /* card title smaller */
      .card-title{font-size:13px}
    }

    /* Touch devices ‚Äî always show delete, bigger tap targets */
    @media(hover:none){
      .img-cell .del{opacity:1;width:26px;height:26px;font-size:12px;top:6px;right:6px}
    }

    /* extra small phones */
    @media(max-width:380px){
      .page{padding:0 10px 60px}
      .card-hd{padding:12px 14px}
      .card-body{padding:12px}
      .logo-text{font-size:20px}
    }
  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header>
    <div>
      <div class="logo-main"><span class="logo-text">APOC</span><span class="logo-sup">2</span></div>
      <div class="logo-sub">Tags Technologies ¬∑ Garment Intelligence Platform</div>
    </div>
    <div class="hdr-meta">
      <div id="hdr-ebay" style="color:var(--t3)">eBay: Not Connected</div>
      <div id="hdr-zip" style="color:var(--t3)">ZIP: ‚Äî</div>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ eBay CONNECTION ‚îÄ‚îÄ -->
  <div class="card ebay-card" id="ebay-card">
    <div class="card-hd">
      <div class="card-icon">‚ö°</div>
      <div class="card-title">eBay Marketplace Connection</div>
      <div class="card-badge">OAuth 2.0</div>
    </div>
    <div class="card-body">

      <div id="ebay-nc">
        <div class="ebay-connect-row">
          <div class="ebay-icon-box">üõí</div>
          <div class="ebay-info">
            <div class="ebay-info-title">Connect your eBay seller account</div>
            <div class="ebay-info-sub">Loads your policies and enables live publishing</div>
          </div>
          <a class="ebay-connect-btn" href="#" onclick="startAuth(event)">Connect eBay Account ‚Üí</a>
        </div>
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px">
          <button class="ebay-complete-btn" onclick="completeAuth()">Complete Authorization</button>
          <span id="auth-msg" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t2)"></span>
        </div>
      </div>

      <div id="ebay-cn" style="display:none">
        <div class="connected-badge" style="justify-content:space-between">
          <div style="display:flex;align-items:center;gap:8px">
            <div class="e-dot"></div>
            <span id="ebay-acct">Connected</span>
          </div>
          <button class="ebay-complete-btn" style="padding:6px 12px;font-size:10px" onclick="document.getElementById('ebay-cn').style.display='none';document.getElementById('ebay-nc').style.display='block'">Reconnect</button>
        </div>
      </div>

      <div class="sec-div" style="margin-top:0"></div>

      <!-- POLICIES ‚Äî 3 cols -->
      <div class="g3" style="margin-bottom:14px">
        <div>
          <label class="lbl">Shipping Policy</label>
          <select class="f-sel" id="ship-policy" onchange="savePolicies()">
            <option value="">‚Äî Connect eBay first ‚Äî</option>
          </select>
        </div>
        <div>
          <label class="lbl">Return Policy</label>
          <select class="f-sel" id="ret-policy" onchange="savePolicies()">
            <option value="">‚Äî Connect eBay first ‚Äî</option>
          </select>
        </div>
        <div>
          <label class="lbl">Payment Policy</label>
          <select class="f-sel" id="pay-policy" onchange="savePolicies()">
            <option value="">‚Äî Connect eBay first ‚Äî</option>
          </select>
        </div>
      </div>

      <!-- ZIP + listing format + duration -->
      <div class="g3">
        <div>
          <label class="lbl">Origin ZIP Code
            <span id="zip-status" class="zip-status" style="color:var(--t3);margin-left:8px"></span>
          </label>
          <input class="f-inp mono" id="zip-inp" type="text" value="" placeholder="Detecting..." maxlength="10" oninput="saveZip()" />
        </div>
        <div>
          <label class="lbl">Listing Format</label>
          <select class="f-sel" id="list-fmt" onchange="onFormatChange();savePolicies()">
            <option value="FixedPriceItem">Fixed Price</option>
            <option value="Chinese">Auction</option>
          </select>
        </div>
        <div>
          <label class="lbl">Listing Duration</label>
          <select class="f-sel" id="list-dur" onchange="savePolicies()">
            <option value="GTC">Good Till Cancelled</option>
            <option value="Days_30">30 Days</option>
            <option value="Days_7">7 Days</option>
          </select>
        </div>
      </div>

      <!-- Dispatch + price fields -->
      <div class="g3" style="margin-top:12px">
        <div>
          <label class="lbl">Dispatch Time</label>
          <select class="f-sel" id="dispatch" onchange="savePolicies()">
            <option value="1">1 business day</option>
            <option value="2">2 business days</option>
            <option value="3" selected>3 business days</option>
            <option value="5">5 business days</option>
          </select>
        </div>
        <div id="price-group-1">
          <label class="lbl" id="price-lbl-1">Buy It Now Price ($)</label>
          <input class="f-inp mono" id="price-inp" type="number" step="0.01" min="0.99" placeholder="0.00" oninput="savePolicies()" />
        </div>
        <div id="price-group-2" style="display:none">
          <label class="lbl">Buy It Now ($) <span style="color:var(--t3)">optional</span></label>
          <input class="f-inp mono" id="bin-price-inp" type="number" step="0.01" min="0" placeholder="Optional" oninput="savePolicies()" />
        </div>
      </div>

      <!-- Best Offer (fixed price only) -->
      <div id="offer-wrap" style="margin-top:12px">
        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <label class="toggle">
            <input type="checkbox" id="best-offer-chk" onchange="onOfferToggle();savePolicies()">
            <span class="toggle-track"></span>
          </label>
          <label class="toggle-label" for="best-offer-chk">Accept Best Offer</label>
          <div id="min-offer-wrap" style="display:none;margin-left:12px">
            <input class="f-inp mono" id="min-offer-inp" type="number" step="0.01" min="0" placeholder="Min offer $" style="width:140px" oninput="savePolicies()" />
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <span class="save-note" id="save-note">‚úì Settings saved</span>
      </div>

    </div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 1: CAPTURE ‚îÄ‚îÄ -->
  <div class="card active" id="s1">
    <div class="card-hd">
      <div class="card-icon">01</div>
      <div class="card-title">Capture Garment Photos</div>
      <div class="card-badge">12 images max</div>
    </div>
    <div class="card-body">
      <div class="drop-zone" id="dz" onclick="document.getElementById('fi').click()">
        <div class="up-ico">‚Üë</div>
        <div><div class="up-title">Drop photos or click to upload</div>
        <div class="up-sub">Include clear close-ups of size tag, brand label, and care/content label ¬∑ JPG / PNG</div></div>
      </div>
      <input type="file" id="fi" multiple accept="image/*" style="display:none"/>
      <div style="margin-top:14px;margin-bottom:4px">
        <label class="lbl">Department</label>
        <select class="f-sel" id="gender-sel" style="max-width:220px" onchange="savePolicies()">
          <option value="Men">Men</option>
          <option value="Women">Women</option>
          <option value="Unisex">Unisex</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
        </select>
      </div>
      <div class="act-row">
        <button class="btn" onclick="clearAll()">‚úï Clear</button>
        <button class="btn" id="bg-btn" onclick="removeBg()">Remove Background</button>
        <button class="btn pri" id="abtn" onclick="doAnalysis()">Analyze Garment ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 2: REPORT ‚îÄ‚îÄ -->
  <div class="card" id="s2">
    <div class="card-hd">
      <div class="card-icon">02</div>
      <div class="card-title">Intelligence Report</div>
      <div class="card-badge">Claude Sonnet 4.6</div>
    </div>
    <div class="card-body" id="s2body">
      <div style="text-align:center;padding:20px 0;font-family:'DM Mono',monospace;font-size:11px;color:var(--t3)">Upload photos then run analysis</div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ STEP 3: PUBLISH ‚îÄ‚îÄ -->
  <div class="card" id="s3">
    <div class="card-hd">
      <div class="card-icon">03</div>
      <div class="card-title">Review &amp; Publish to eBay</div>
    </div>
    <div class="card-body">
      <div id="pub-preview" style="background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 16px;margin-bottom:14px;font-family:'DM Mono',monospace;font-size:11px;color:var(--t2);line-height:1.8">
        Complete analysis above to see listing preview.
      </div>
      <button class="btn pub" id="pbtn" onclick="publish()">Publish Listing to eBay ‚Üí</button>
      <div class="pub-res" id="pres"></div>
    </div>
  </div>

</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PERSIST ‚Äî policies + zip survive page refresh
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function savePolicies() {
  localStorage.setItem('apoc2_policies', JSON.stringify({
    ship:      document.getElementById('ship-policy').value,
    ret:       document.getElementById('ret-policy').value,
    pay:       document.getElementById('pay-policy').value,
    fmt:       document.getElementById('list-fmt').value,
    dur:       document.getElementById('list-dur').value,
    disp:      document.getElementById('dispatch').value,
    gender:    document.getElementById('gender-sel').value,
    price:     document.getElementById('price-inp').value,
    binPrice:  document.getElementById('bin-price-inp').value,
    bestOffer: document.getElementById('best-offer-chk').checked,
    minOffer:  document.getElementById('min-offer-inp').value,
  }));
  flashSave();
}
function onFormatChange() {
  const fmt = document.getElementById('list-fmt').value;
  const durSel = document.getElementById('list-dur');
  const priceLbl = document.getElementById('price-lbl-1');
  const priceGroup2 = document.getElementById('price-group-2');
  const offerWrap = document.getElementById('offer-wrap');
  if (fmt === 'Chinese') {
    durSel.innerHTML = '<option value="Days_1">1 Day</option><option value="Days_3">3 Days</option><option value="Days_5">5 Days</option><option value="Days_7" selected>7 Days</option><option value="Days_10">10 Days</option>';
    priceLbl.textContent = 'Starting Bid ($)';
    priceGroup2.style.display = '';
    if (offerWrap) offerWrap.style.display = 'none';
  } else {
    durSel.innerHTML = '<option value="GTC">Good Till Cancelled</option><option value="Days_30">30 Days</option><option value="Days_7">7 Days</option>';
    priceLbl.textContent = 'Buy It Now Price ($)';
    priceGroup2.style.display = 'none';
    if (offerWrap) offerWrap.style.display = '';
  }
}
function onOfferToggle() {
  const checked = document.getElementById('best-offer-chk').checked;
  document.getElementById('min-offer-wrap').style.display = checked ? '' : 'none';
}
function saveZip() {
  localStorage.setItem('apoc2_zip', document.getElementById('zip-inp').value);
}
function flashSave() {
  const n = document.getElementById('save-note');
  n.classList.add('show');
  clearTimeout(n._t);
  n._t = setTimeout(() => n.classList.remove('show'), 2000);
}
function saveEbayPolicies(data) {
  localStorage.setItem('apoc2_ebay', JSON.stringify({
    shipping: data.shipping_policies || [],
    return:   data.return_policies || [],
    payment:  data.payment_policies || [],
  }));
}
function fillDropdownFromList(selId, list) {
  const sel = document.getElementById(selId);
  if (!list.length) return;
  sel.innerHTML = list.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
}
function loadSaved() {
  // Restore cached eBay policy lists so dropdowns are populated instantly
  const ebay = JSON.parse(localStorage.getItem('apoc2_ebay') || 'null');
  const rt = localStorage.getItem('apoc2_ebay_refresh');
  if (ebay) {
    fillDropdownFromList('ship-policy', ebay.shipping || []);
    fillDropdownFromList('ret-policy',  ebay.return || []);
    fillDropdownFromList('pay-policy',  ebay.payment || []);
    document.getElementById('ebay-nc').style.display = 'none';
    document.getElementById('ebay-cn').style.display = 'block';
    document.getElementById('ebay-card').className = 'card ebay-card linked';
    if (rt) {
      document.getElementById('ebay-acct').textContent = '‚úì Reconnecting...';
      document.getElementById('hdr-ebay').textContent = 'eBay: Reconnecting...';
      document.getElementById('hdr-ebay').style.color = 'var(--amber)';
      ebayConnected = true;
    } else {
      document.getElementById('ebay-acct').textContent = 'Policies loaded ¬∑ Reconnect once to enable auto-login';
      document.getElementById('hdr-ebay').textContent = 'eBay: Reconnect needed';
      document.getElementById('hdr-ebay').style.color = 'var(--amber)';
      ebayConnected = false;
    }
  }
  // Restore saved selections
  const p = JSON.parse(localStorage.getItem('apoc2_policies') || '{}');
  if (p.ship)   document.getElementById('ship-policy').value = p.ship;
  if (p.ret)    document.getElementById('ret-policy').value  = p.ret;
  if (p.pay)    document.getElementById('pay-policy').value  = p.pay;
  if (p.fmt) { document.getElementById('list-fmt').value = p.fmt; onFormatChange(); }
  if (p.dur)    document.getElementById('list-dur').value    = p.dur;
  if (p.disp)   document.getElementById('dispatch').value    = p.disp;
  if (p.gender) document.getElementById('gender-sel').value  = p.gender;
  if (p.price)    document.getElementById('price-inp').value     = p.price;
  if (p.binPrice) document.getElementById('bin-price-inp').value = p.binPrice;
  if (p.bestOffer) { document.getElementById('best-offer-chk').checked = true; onOfferToggle(); }
  if (p.minOffer)  document.getElementById('min-offer-inp').value = p.minOffer;
  const z = localStorage.getItem('apoc2_zip');
  if (z) { document.getElementById('zip-inp').value = z; setZipStatus(z, 'saved'); }
  // Auto-reconnect eBay using refresh token
  if (rt) autoReconnectEbay(rt);
}
async function autoReconnectEbay(refreshToken) {
  try {
    const resp = await fetch(`${API}/ebay-refresh`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({refresh_token: refreshToken}),
    });
    const data = await resp.json();
    if (data.error) {
      localStorage.removeItem('apoc2_ebay_refresh');
      document.getElementById('ebay-acct').textContent = 'Policies loaded ¬∑ Reconnect to publish';
      document.getElementById('hdr-ebay').textContent = 'eBay: Reconnect needed';
      document.getElementById('hdr-ebay').style.color = 'var(--amber)';
      ebayConnected = false;
      return;
    }
    if (data.connected) {
      fillDropdownFromList('ship-policy', data.shipping_policies || []);
      fillDropdownFromList('ret-policy',  data.return_policies || []);
      fillDropdownFromList('pay-policy',  data.payment_policies || []);
      saveEbayPolicies(data);
      const sc=(data.shipping_policies||[]).length, rc=(data.return_policies||[]).length, pc=(data.payment_policies||[]).length;
      document.getElementById('ebay-acct').textContent = `‚úì Connected ¬∑ ${sc} shipping ¬∑ ${rc} return ¬∑ ${pc} payment policies`;
      document.getElementById('hdr-ebay').textContent = 'eBay: Connected';
      document.getElementById('hdr-ebay').style.color = 'var(--green)';
      // Restore saved policy selections after fresh dropdown fill
      const p = JSON.parse(localStorage.getItem('apoc2_policies') || '{}');
      if (p.ship) document.getElementById('ship-policy').value = p.ship;
      if (p.ret)  document.getElementById('ret-policy').value  = p.ret;
      if (p.pay)  document.getElementById('pay-policy').value  = p.pay;
      ebayConnected = true;
    }
  } catch(err) {
    document.getElementById('ebay-acct').textContent = 'Policies loaded ¬∑ Reconnect to publish';
    document.getElementById('hdr-ebay').textContent = 'eBay: Offline';
    document.getElementById('hdr-ebay').style.color = 'var(--amber)';
    ebayConnected = false;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ZIP ‚Äî GPS first, IP fallback
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function setZipStatus(zip, src) {
  const el = document.getElementById('zip-status');
  const hdr = document.getElementById('hdr-zip');
  if (src === 'gps')   { el.textContent = '‚úì GPS'; el.style.color = 'var(--green)'; }
  if (src === 'ip')    { el.textContent = '‚úì IP'; el.style.color = 'var(--amber)'; }
  if (src === 'saved') { el.textContent = '‚Ü∫ Saved'; el.style.color = 'var(--t2)'; }
  hdr.textContent = 'ZIP: ' + zip;
  hdr.style.color = src === 'gps' ? 'var(--green)' : 'var(--t2)';
  setTimeout(() => { if (src !== 'saved') el.textContent = ''; }, 5000);
}

async function zipFromIP() {
  try {
    const r = await fetch('https://ipinfo.io/json');
    const d = await r.json();
    return d.postal || null;
  } catch { return null; }
}

async function zipFromCoords(lat, lon) {
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
    const d = await r.json();
    return d.address?.postcode?.split('-')[0] || null;
  } catch { return null; }
}

function detectZip() {
  const saved = localStorage.getItem('apoc2_zip');
  if (saved) { loadSaved(); return; }

  const inp = document.getElementById('zip-inp');
  inp.placeholder = 'Detecting via GPS...';

  if (!navigator.geolocation) { fallbackIP(); return; }

  navigator.geolocation.getCurrentPosition(
    async pos => {
      const zip = await zipFromCoords(pos.coords.latitude, pos.coords.longitude);
      if (zip) {
        inp.value = zip;
        localStorage.setItem('apoc2_zip', zip);
        setZipStatus(zip, 'gps');
      } else { fallbackIP(); }
    },
    async () => { fallbackIP(); },
    { timeout: 6000, maximumAge: 600000 }
  );
}

async function fallbackIP() {
  const zip = await zipFromIP();
  const inp = document.getElementById('zip-inp');
  if (zip) {
    inp.value = zip;
    localStorage.setItem('apoc2_zip', zip);
    setZipStatus(zip, 'ip');
  } else {
    inp.placeholder = 'Enter ZIP manually';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   eBay AUTH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let ebayConnected = false;
async function startAuth(e) {
  e.preventDefault();
  const msg = document.getElementById('auth-msg');
  msg.textContent = 'Loading eBay authorization...';
  try {
    const resp = await fetch(`${API}/ebay-auth-url`);
    const data = await resp.json();
    if (data.error) { msg.textContent = 'Error: ' + data.error; return; }
    window.open(data.url, '_blank');
    msg.textContent = 'Complete sign-in on eBay, then click Complete Authorization ‚Üì';
  } catch(err) {
    msg.textContent = 'Failed to get auth URL: ' + err.message;
  }
}
async function completeAuth() {
  const msg = document.getElementById('auth-msg');
  msg.textContent = 'Completing authorization...';
  try {
    const resp = await fetch(`${API}/ebay-complete`, { method: 'POST' });
    const data = await resp.json();
    if (data.error) { msg.textContent = 'Error: ' + data.error; return; }
    if (!data.connected) { msg.textContent = 'Authorization incomplete. Sign in on eBay first.'; return; }

    msg.textContent = '';
    document.getElementById('ebay-nc').style.display = 'none';
    document.getElementById('ebay-cn').style.display = 'block';
    const sc = (data.shipping_policies||[]).length;
    const rc = (data.return_policies||[]).length;
    const pc = (data.payment_policies||[]).length;
    document.getElementById('ebay-acct').textContent = `‚úì Connected ¬∑ ${sc} shipping ¬∑ ${rc} return ¬∑ ${pc} payment policies`;
    document.getElementById('hdr-ebay').textContent = 'eBay: Connected';
    document.getElementById('hdr-ebay').style.color = 'var(--green)';
    document.getElementById('ebay-card').className = 'card ebay-card linked';

    function fillPolicy(selId, policies) {
      const sel = document.getElementById(selId);
      sel.innerHTML = policies.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      const saved = JSON.parse(localStorage.getItem('apoc2_policies') || '{}');
      const key = selId.replace('-policy','');
      if (saved[key]) sel.value = saved[key];
    }
    fillPolicy('ship-policy', data.shipping_policies || []);
    fillPolicy('ret-policy',  data.return_policies || []);
    fillPolicy('pay-policy',  data.payment_policies || []);

    saveEbayPolicies(data);
    if (data.refresh_token) localStorage.setItem('apoc2_ebay_refresh', data.refresh_token);
    ebayConnected = true;
    savePolicies();
  } catch(err) {
    msg.textContent = 'Connection failed: ' + err.message;
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FILES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let files = [], analysisData = null;
document.getElementById('fi').addEventListener('change', e => addFiles(e.target.files));
const dz = document.getElementById('dz');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); addFiles(e.dataTransfer.files); });
async function addFiles(f) {
  for (const x of Array.from(f)) {
    if (files.length >= 12) break;
    try {
      const fixed = await normalizeOrientation(x);
      files.push(fixed);
    } catch(e) { files.push(x); }
  }
  renderDZ();
}
function normalizeOrientation(file) {
  return new Promise((resolve) => {
    createImageBitmap(file).then(bmp => {
      const cvs = document.createElement('canvas');
      cvs.width = bmp.width; cvs.height = bmp.height;
      cvs.getContext('2d').drawImage(bmp, 0, 0);
      cvs.toBlob(blob => {
        if (!blob) { resolve(file); return; }
        resolve(new File([blob], file.name, { type: 'image/jpeg', lastModified: file.lastModified }));
      }, 'image/jpeg', 0.92);
    }).catch(() => resolve(file));
  });
}
function renderDZ() {
  if (!files.length) {
    dz.className = 'drop-zone';
    dz.innerHTML = `<div class="up-ico">‚Üë</div><div><div class="up-title">Drop photos or click to upload</div><div class="up-sub">Include clear close-ups of size tag, brand label, and care/content label ¬∑ JPG / PNG</div></div>`;
    dz.onclick = () => document.getElementById('fi').click();
  } else {
    dz.className = 'drop-zone filled';
    let h = '<div class="img-grid">';
    files.forEach((f,i) => { const u=URL.createObjectURL(f); h+=`<div class="img-cell" onclick="openEditor(${i})"><img src="${u}"/><button class="del" onclick="event.stopPropagation();delF(${i})">‚úï</button></div>`; });
    if (files.length<12) h+=`<div class="img-add" onclick="event.stopPropagation();document.getElementById('fi').click()">+</div>`;
    h+='</div>';
    dz.innerHTML=h; dz.onclick=null;
  }
}
function delF(i){files.splice(i,1);renderDZ();}
function clearAll(){files=[];renderDZ();}
async function removeBg(){
  if(!files.length) return;
  const b=document.getElementById('bg-btn');
  b.innerHTML='<span class="spin">‚óå</span> Removing backgrounds...';b.disabled=true;
  b.style.color='';b.style.borderColor='';
  try{
    const fd=new FormData();
    files.forEach(f=>fd.append('images',f));
    const resp=await fetch(`${API}/remove-bg`,{method:'POST',body:fd});
    if(!resp.ok){const e=await resp.json();throw new Error(e.error||`HTTP ${resp.status}`);}
    const result=await resp.json();
    if(!result.success) throw new Error(result.error||'Background removal failed');
    const newFiles=[];
    for(let i=0;i<result.images.length;i++){
      const b64=result.images[i];
      const bin=atob(b64);const arr=new Uint8Array(bin.length);
      for(let j=0;j<bin.length;j++) arr[j]=bin.charCodeAt(j);
      const blob=new Blob([arr],{type:'image/jpeg'});
      newFiles.push(new File([blob],files[i]?.name||`photo_${i+1}.jpg`,{type:'image/jpeg'}));
    }
    files=newFiles;
    renderDZ();
    b.innerHTML='‚úì Background Removed';b.disabled=false;
    b.style.color='var(--green)';b.style.borderColor='var(--green-b)';
  }catch(err){
    b.innerHTML='‚úó Failed';b.disabled=false;
    b.style.color='var(--red)';b.style.borderColor='rgba(224,92,92,.28)';
    setTimeout(()=>{b.innerHTML='Remove Background';b.style.color='';b.style.borderColor='';},3000);
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CROP / ROTATE EDITOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openEditor(index) {
  const file = files[index];
  if (!file) return;
  const img = new Image();
  img.onload = function() {
    const state = { img, rotation: 0, crop: null, dragging: false, startX: 0, startY: 0 };

    // Modal
    const modal = document.createElement('div');
    modal.className = 'edit-modal';

    // Canvas
    const cvs = document.createElement('canvas');
    setupCanvas(cvs, state);
    drawEditor(cvs, state);
    modal.appendChild(cvs);

    // Hint
    const hint = document.createElement('div');
    hint.className = 'crop-hint';
    hint.textContent = 'Click + drag on image to crop ¬∑ Use buttons to rotate';
    modal.appendChild(hint);

    // Toolbar
    const bar = document.createElement('div');
    bar.className = 'edit-toolbar';
    const mkBtn = (label, cls, fn) => { const b = document.createElement('button'); b.className = 'btn' + (cls ? ' ' + cls : ''); b.textContent = label; b.onclick = fn; return b; };

    bar.appendChild(mkBtn('‚Ü∫ Rotate Left', '', () => { state.rotation = (state.rotation + 270) % 360; state.crop = null; setupCanvas(cvs, state); drawEditor(cvs, state); }));
    bar.appendChild(mkBtn('Rotate Right ‚Üª', '', () => { state.rotation = (state.rotation + 90) % 360; state.crop = null; setupCanvas(cvs, state); drawEditor(cvs, state); }));
    bar.appendChild(mkBtn('Reset Crop', '', () => { state.crop = null; drawEditor(cvs, state); }));
    bar.appendChild(mkBtn('Apply', 'pri', () => { applyEdit(state, index, modal); }));
    bar.appendChild(mkBtn('Cancel', '', () => { modal.remove(); }));
    modal.appendChild(bar);

    // Mouse/touch events for crop
    const getPos = (e) => {
      const r = cvs.getBoundingClientRect();
      const sx = cvs.width / r.width, sy = cvs.height / r.height;
      const t = e.touches ? e.touches[0] : e;
      return { x: (t.clientX - r.left) * sx, y: (t.clientY - r.top) * sy };
    };
    const onDown = (e) => { e.preventDefault(); const p = getPos(e); state.dragging = true; state.startX = p.x; state.startY = p.y; state.crop = null; };
    const onMove = (e) => { if (!state.dragging) return; e.preventDefault(); const p = getPos(e); state.crop = { x: Math.min(state.startX, p.x), y: Math.min(state.startY, p.y), w: Math.abs(p.x - state.startX), h: Math.abs(p.y - state.startY) }; drawEditor(cvs, state); };
    const onUp = () => { state.dragging = false; if (state.crop && (state.crop.w < 10 || state.crop.h < 10)) state.crop = null; };
    cvs.addEventListener('mousedown', onDown);
    cvs.addEventListener('mousemove', onMove);
    cvs.addEventListener('mouseup', onUp);
    cvs.addEventListener('touchstart', onDown, { passive: false });
    cvs.addEventListener('touchmove', onMove, { passive: false });
    cvs.addEventListener('touchend', onUp);

    // Close on backdrop click
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });

    document.body.appendChild(modal);
  };
  img.src = URL.createObjectURL(file);
}

function setupCanvas(cvs, state) {
  const img = state.img;
  const swap = state.rotation % 180 !== 0;
  cvs.width = swap ? img.height : img.width;
  cvs.height = swap ? img.width : img.height;
}

function drawEditor(cvs, state) {
  const ctx = cvs.getContext('2d');
  const img = state.img;
  ctx.clearRect(0, 0, cvs.width, cvs.height);
  ctx.save();
  ctx.translate(cvs.width / 2, cvs.height / 2);
  ctx.rotate(state.rotation * Math.PI / 180);
  ctx.drawImage(img, -img.width / 2, -img.height / 2);
  ctx.restore();

  // Draw crop overlay
  if (state.crop && state.crop.w > 2 && state.crop.h > 2) {
    const c = state.crop;
    ctx.fillStyle = 'rgba(0,0,0,0.5)';
    ctx.fillRect(0, 0, cvs.width, c.y);
    ctx.fillRect(0, c.y, c.x, c.h);
    ctx.fillRect(c.x + c.w, c.y, cvs.width - c.x - c.w, c.h);
    ctx.fillRect(0, c.y + c.h, cvs.width, cvs.height - c.y - c.h);
    ctx.strokeStyle = 'var(--amber)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    ctx.strokeRect(c.x, c.y, c.w, c.h);
    ctx.setLineDash([]);
  }
}

function applyEdit(state, index, modal) {
  const off = document.createElement('canvas');
  const img = state.img;
  const swap = state.rotation % 180 !== 0;
  let srcW = swap ? img.height : img.width;
  let srcH = swap ? img.width : img.height;

  if (state.crop) {
    off.width = state.crop.w;
    off.height = state.crop.h;
  } else {
    off.width = srcW;
    off.height = srcH;
  }

  const ctx = off.getContext('2d');
  // Draw rotated full image onto a temp canvas first
  const tmp = document.createElement('canvas');
  tmp.width = srcW; tmp.height = srcH;
  const tc = tmp.getContext('2d');
  tc.translate(srcW / 2, srcH / 2);
  tc.rotate(state.rotation * Math.PI / 180);
  tc.drawImage(img, -img.width / 2, -img.height / 2);

  if (state.crop) {
    ctx.drawImage(tmp, state.crop.x, state.crop.y, state.crop.w, state.crop.h, 0, 0, state.crop.w, state.crop.h);
  } else {
    ctx.drawImage(tmp, 0, 0);
  }

  off.toBlob((blob) => {
    if (!blob) { if (modal) modal.remove(); return; }
    const newFile = new File([blob], files[index]?.name || `photo_${index + 1}.jpg`, { type: 'image/jpeg' });
    files[index] = newFile;
    renderDZ();
    if (modal) modal.remove();
  }, 'image/jpeg', 0.92);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEO TITLE BUILDER
   Priority order: Brand ¬∑ Gender ¬∑ Type ¬∑ Material ¬∑ Size ¬∑ Color ¬∑ Key features ¬∑ Origin
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSeoTitle(d) {
  // Ranked keyword tokens ‚Äî only include if they add search value
  const parts = [];

  // 1. Brand (always first ‚Äî highest search weight)
  if (d.brand) parts.push(d.brand);

  // 2. Sub-brand / line (e.g. "Storm System") ‚Äî high brand search value
  if (d.sub_brand && d.sub_brand !== 'null') parts.push(d.sub_brand);

  // 3. Material ‚Äî luxury buyers search by material
  if (d.material && !parts.join(' ').toLowerCase().includes(d.material.toLowerCase()))
    parts.push(d.material);

  // 4. Garment type (leaf category)
  const type = d.cat ? d.cat.split('>').pop().trim() : '';
  if (type) parts.push(type);

  // 5. Gender department
  if (d.gender && d.gender !== 'Unisex') parts.push(d.gender + "'s");

  // 6. Dominant style detail
  if (d.style && d.style[0]) parts.push(d.style[0]);

  // 7. Size
  if (d.size) parts.push('Size ' + d.size);

  // 8. Color
  if (d.color) parts.push(d.color);

  // 9. Country of origin (valuable for luxury)
  if (d.origin && d.origin !== 'null') parts.push(d.origin);

  // 10. NWT signal
  if (d.nwt) parts.push('NWT');

  // Vintage era
  if (d.vintage && d.era && d.era !== 'null') parts.push(d.era);

  // Join and trim to 80 chars, never cutting mid-word
  let title = parts.join(' ');
  if (title.length > 80) {
    title = title.substring(0, 80);
    title = title.substring(0, title.lastIndexOf(' '));
  }
  return title;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONFIG ‚Äî point at your HuggingFace Space
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const API = 'https://tien1868-apoc-app.hf.space';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANALYSIS ‚Äî real API call
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const ASTEPS = [
  ['Uploading photos',       'Photos received'],
  ['OCR ¬∑ Tag Reading',      'Tag text extracted'],
  ['Brand Identification',   'Brand confirmed'],
  ['Garment Classification', 'Category + size identified'],
  ['Generating listing',     'Title + specifics ready'],
];

async function doAnalysis() {
  if (!files.length) { dz.style.borderColor='var(--red)'; setTimeout(()=>dz.style.borderColor='',1200); return; }
  const btn = document.getElementById('abtn');
  btn.disabled=true; btn.innerHTML='<span class="spin">‚óå</span> Analyzing...';
  document.getElementById('s2').className='card active';

  // Show progress UI
  let ph='<div class="prog-wrap">';
  ASTEPS.forEach(([n],i)=>{ ph+=`<div class="prog-row"><div class="prog-n">0${i+1}</div><div class="prog-name">${n}</div><div class="prog-s w" id="p${i}">‚Äî Waiting</div></div>`; });
  ph+='</div>';
  document.getElementById('s2body').innerHTML=ph;

  // Tick first step
  const tick = (i, msg) => {
    const e = document.getElementById(`p${i}`);
    if (e) { e.textContent = msg; e.className = msg.startsWith('‚úì') ? 'prog-s d' : 'prog-s r'; }
  };
  tick(0, '...');

  try {
    const fd = new FormData();
    files.forEach(f => fd.append('images', f));
    fd.append('gender', document.getElementById('gender-sel').value);

    tick(0, '‚úì Photos received');
    tick(1, '...');

    const resp = await fetch(`${API}/analyze`, { method:'POST', body:fd });
    tick(1, '‚úì Tag text extracted');
    tick(2, '...');

    if (!resp.ok) {
      const err = await resp.json();
      throw new Error(err.error || `HTTP ${resp.status}`);
    }

    const result = await resp.json();
    if (!result.success) throw new Error(result.error || 'Analysis failed');

    tick(2, '‚úì Brand confirmed');
    tick(3, '‚úì Category identified');
    tick(4, '‚úì Listing ready');

    setTimeout(() => {
      btn.disabled=false; btn.innerHTML='‚Ü∫ Re-analyze';
      document.getElementById('s2').className='card done';
      document.getElementById('s3').className='card active';
      buildReport(result.data);
    }, 600);

  } catch(err) {
    document.getElementById('s2body').innerHTML =
      `<div style="padding:16px;color:var(--red);font-family:'DM Mono',monospace;font-size:12px">
        ‚úó Analysis failed: ${err.message}<br><br>
        Make sure your HuggingFace Space is running at:<br>${API}
      </div>`;
    btn.disabled=false; btn.innerHTML='‚Ü∫ Retry';
    document.getElementById('s2').className='card';
  }
}

function genSku(d) {
  const b = (d.brand || 'UNK').replace(/[^A-Za-z0-9]/g,'').substring(0,4).toUpperCase();
  const c = (d.cat || '').split('>').pop().trim().substring(0,3).toUpperCase() || 'GEN';
  const s = (d.size || 'OS').replace(/[^A-Za-z0-9]/g,'').substring(0,4).toUpperCase();
  const t = new Date().toISOString().slice(2,10).replace(/-/g,'');
  return `${b}-${c}-${s}-${t}`;
}

async function loadComps(d) {
  const el = document.getElementById('comps-list');
  if (!el) return;
  const cat = (d.cat || '').split('>').pop().trim();
  const query = [d.brand, d.gender, cat, d.size].filter(Boolean).join(' ');
  if (!query.trim()) { el.textContent = 'Not enough data for comps'; return; }
  try {
    const resp = await fetch(`${API}/comps`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({query})
    });
    const data = await resp.json();
    if (!data.comps || !data.comps.length) { el.textContent = 'No comparable listings found'; return; }
    let h = '<div class="comps-scroll">';
    data.comps.forEach(c => {
      h += `<a href="${c.url}" target="_blank" style="text-decoration:none;color:inherit" class="comp-card">`;
      if (c.image) h += `<img src="${c.image}" alt="" />`;
      h += `<div class="comp-info"><div class="comp-price">$${c.price}</div>`;
      h += `<div class="comp-title">${c.title}</div>`;
      if (c.condition) h += `<div class="comp-cond">${c.condition}</div>`;
      h += `</div></a>`;
    });
    h += '</div>';
    if (data.avg_price) h += `<div class="comps-avg">Avg market price: <span style="color:var(--amber)">$${data.avg_price.toFixed(2)}</span> across ${data.count} listings</div>`;
    el.innerHTML = h;
  } catch(err) {
    el.textContent = 'Could not load comps';
  }
}

function buildReport(raw) {
  // Map API response fields to UI fields
  const mapped = {
    brand:        raw.brand || '',
    sub_brand:    raw.sub_brand && raw.sub_brand !== 'null' ? raw.sub_brand : null,
    cat:          raw.category || '',
    cat_id:       raw.cat_id || '',
    gender:       raw.gender || 'Unisex',
    dept:         raw.gender || 'Unisex',
    size:         raw.size || '',
    size_type:    raw.size_type || 'Regular',
    color:        raw.color || '',
    color_std:    raw.color_std || raw.color || '',
    material:     raw.material || '',
    material_full:raw.material || '',
    sleeve:       raw.sleeve_length || 'Long Sleeve',
    neckline:     raw.neckline || '',
    style:        raw.style_details || [],
    origin:       raw.origin || '',
    nwt:          raw.tags_present || false,
    vintage:      raw.vintage || false,
    era:          raw.vintage_era || 'Contemporary',
    cond_score:   raw.condition_score || 4,
    cond_label:   raw.condition_label || 'Good',
    cond_note:    raw.condition_notes || '',
    defects:      raw.defects_detected || [],
    desc:         raw.description || '',
    price_low:    raw.suggested_price_low || 0,
    price_high:   raw.suggested_price_high || 0,
    price_rec:    raw.suggested_price_low || 0,
    price_reasoning: raw.price_reasoning || '',
    pattern:      raw.pattern || 'Solid',
    closure:      raw.closure || '',
    fit:          raw.fit || 'Regular Fit',
    occasion:     raw.occasion || 'Casual',
    season:       raw.season || 'All Seasons',
    lining:       raw.lining_material || '',
    features:     raw.features || [],
    care_instructions: raw.care_instructions || '',
    conf_brand:   raw.confidence === 'high' ? 90 : raw.confidence === 'medium' ? 70 : 50,
    conf_cat:     raw.confidence === 'high' ? 88 : 65,
    conf_gender:  95,
    conf_size:    raw.size ? 85 : 60,
  };

  const title = raw.title || buildSeoTitle(mapped);
  const keywords = [mapped.brand, mapped.sub_brand, mapped.material_full, mapped.color, mapped.origin, mapped.gender+"'s", mapped.size, ...(mapped.style||[])].filter(Boolean);

  analysisData = { ...mapped, title, keywords };

  // Auto-fill price from analysis if empty
  const priceInp = document.getElementById('price-inp');
  if (priceInp && !priceInp.value) {
    priceInp.value = mapped.price_high || mapped.price_low || '';
    savePolicies();
  }

  const d = analysisData;
  const chars = title.length;

  document.getElementById('s2body').innerHTML = `<div class="fade-in">

    <!-- TITLE -->
    <div class="title-box">
      <label class="lbl">eBay Listing Title <span style="color:var(--amber);font-size:8px">SEO OPTIMIZED</span></label>
      <textarea class="title-area" id="ttl" rows="2" oninput="upChars(this)">${title}</textarea>
      <div class="char-hint">
        <span id="cc" style="color:${chars>70?'var(--amber)':'var(--green)'}">${chars}</span> / 80 chars
        &nbsp;¬∑&nbsp; Ranked: Brand ‚Üí Sub-brand ‚Üí Material ‚Üí Type ‚Üí Gender ‚Üí Style ‚Üí Size ‚Üí Color ‚Üí Origin
      </div>
      <div class="seo-tags" style="margin-top:8px">
        ${keywords.map(k=>`<span class="seo-tag">${k}</span>`).join('')}
      </div>
    </div>

    <!-- PRICE + CONFIDENCE -->
    <div class="g2" style="margin-bottom:12px">
      <div class="dbox">
        <div class="lbl">Recommended List Price</div>
        <div class="dval price">$${d.price_low} ‚Äì $${d.price_high}</div>
        <div class="dsub">
          ${d.price_reasoning || 'No pricing data available'}
        </div>
      </div>
      <div class="dbox">
        <div class="lbl">Model Confidence</div>
        ${[['Brand',d.conf_brand],['Category',d.conf_cat],['Gender',d.conf_gender],['Size',d.conf_size]].map(([n,v])=>`
        <div class="conf-row">
          <div class="c-name">${n}</div>
          <div class="c-track"><div class="c-fill ${v>=85?'hi':'md'}" style="width:${v}%"></div></div>
          <div class="c-pct" style="color:${v>=85?'var(--green)':'var(--amber)'}">${v}%</div>
        </div>`).join('')}
      </div>
    </div>

    <!-- MARKET COMPS -->
    <div class="dbox" style="margin-bottom:12px">
      <div class="lbl">Market Comps <span style="font-size:8px;color:var(--t3)">(Active Listings)</span></div>
      <div id="comps-list" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)">Loading comps...</div>
    </div>

    <!-- CONDITION -->
    <div class="dbox" style="margin-bottom:12px">
      <div class="lbl">Condition Report</div>
      <div class="dval grn" style="margin-bottom:6px">${d.cond_score}/5 ‚Äî ${d.cond_label}
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--t2);margin-left:8px">eBay: ${['','New','Like New','Excellent','Good','Fair'][d.cond_score]}</span>
      </div>
      <div style="font-size:12px;color:var(--t2);line-height:1.65">${d.cond_note}</div>
      ${d.defects.length ? `<div class="dsub" style="color:var(--red);margin-top:6px">‚ö† Defects: ${d.defects.join(', ')}</div>` : `<div class="dsub" style="color:var(--green);margin-top:6px">‚úì No defects detected</div>`}
    </div>

    <!-- ITEM SPECIFICS ‚Äî all keyword-populated, all editable -->
    <div class="lbl" style="margin-bottom:8px">Item Specifics
      <span style="color:var(--t3);font-size:8px;letter-spacing:.04em"> ¬∑ Auto-populated from analysis ¬∑ All fields editable</span>
    </div>
    <div class="specs-wrap" style="margin-bottom:12px">

      <div class="spec-row">
        <div class="spec-k">Brand</div>
        <div class="spec-v"><input class="spec-inp" id="sp-brand" value="${d.brand}${d.sub_brand?' / '+d.sub_brand:''}" /></div>
        <div class="spec-k r2">Department</div>
        <div class="spec-v"><select class="spec-sel" id="sp-dept">
          <option ${d.dept==='Men'?'selected':''}>Men</option>
          <option ${d.dept==='Women'?'selected':''}>Women</option>
          <option ${d.dept==='Unisex'?'selected':''}>Unisex</option>
          <option>Boys</option><option>Girls</option>
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Size</div>
        <div class="spec-v"><input class="spec-inp" id="sp-size" value="${d.size}" /></div>
        <div class="spec-k r2">Size Type</div>
        <div class="spec-v"><select class="spec-sel" id="sp-sizetype">
          <option ${d.size_type==='Regular'?'selected':''}>Regular</option>
          <option ${d.size_type==='Plus'?'selected':''}>Plus</option>
          <option ${d.size_type==='Petite'?'selected':''}>Petite</option>
          <option ${d.size_type==='Big &amp; Tall'?'selected':''}>Big &amp; Tall</option>
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Color</div>
        <div class="spec-v"><input class="spec-inp" id="sp-color" value="${d.color}" /></div>
        <div class="spec-k r2">Color Map</div>
        <div class="spec-v"><select class="spec-sel" id="sp-colormap">
          ${['Black','White','Gray','Navy','Blue','Red','Green','Brown','Beige','Cream','Pink','Purple','Multicolor','Yellow','Orange'].map(c=>`<option ${c===d.color_std?'selected':''}>${c}</option>`).join('')}
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Material</div>
        <div class="spec-v"><input class="spec-inp" id="sp-material" value="${d.material_full}" /></div>
        <div class="spec-k r2">Material Map</div>
        <div class="spec-v"><select class="spec-sel" id="sp-materialmap">
          ${['Cotton','Denim','Wool','Leather','Polyester','Nylon','Silk','Linen','Cashmere','Fleece','Velvet','Corduroy','Tweed','Flannel','Suede','Acrylic','Rayon','Viscose'].map(m=>`<option ${m===d.material?'selected':''}>${m}</option>`).join('')}
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Sleeve Length</div>
        <div class="spec-v"><select class="spec-sel" id="sp-sleeve">
          ${['Long Sleeve','Short Sleeve','3/4 Sleeve','Sleeveless','Cap Sleeve'].map(s=>`<option ${s===d.sleeve?'selected':''}>${s}</option>`).join('')}
        </select></div>
        <div class="spec-k r2">Neckline</div>
        <div class="spec-v"><select class="spec-sel" id="sp-neckline">
          ${['Crew Neck','V-Neck','Round Neck','Scoop Neck','Turtleneck','Mock Neck','Collared','Hooded','Polo','Henley','Boat Neck','Cowl Neck','Square Neck','Off Shoulder','Strapless'].map(n=>`<option ${n===d.neckline?'selected':''}>${n}</option>`).join('')}
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Style</div>
        <div class="spec-v"><input class="spec-inp" id="sp-style" value="${(d.style||[]).join(', ')}" /></div>
        <div class="spec-k r2">Garment Type</div>
        <div class="spec-v"><input class="spec-inp" id="sp-type" value="${d.cat?d.cat.split('>').pop().trim():''}" /></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Country/Region</div>
        <div class="spec-v"><input class="spec-inp" id="sp-origin" value="${d.origin||''}" /></div>
        <div class="spec-k r2">Vintage</div>
        <div class="spec-v"><select class="spec-sel" id="sp-vintage">
          <option ${!d.vintage?'selected':''}>No</option>
          <option ${d.vintage?'selected':''}>Yes</option>
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">New w/ Tags</div>
        <div class="spec-v"><select class="spec-sel" id="sp-nwt">
          <option ${!d.nwt?'selected':''}>No</option>
          <option ${d.nwt?'selected':''}>Yes</option>
        </select></div>
        <div class="spec-k r2">Era</div>
        <div class="spec-v"><input class="spec-inp" id="sp-era" value="${d.vintage?d.era:'Contemporary'}" /></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Pattern</div>
        <div class="spec-v"><select class="spec-sel" id="sp-pattern">
          ${['Solid','Striped','Plaid','Paisley','Floral','Geometric','Abstract','Animal Print','Camouflage','Polka Dot','Colorblock','Herringbone','Houndstooth','Checkered/Gingham'].map(p=>`<option ${p===d.pattern?'selected':''}>${p}</option>`).join('')}
        </select></div>
        <div class="spec-k r2">Closure</div>
        <div class="spec-v"><select class="spec-sel" id="sp-closure">
          ${['Button','Zip','Pull On','Snap','Hook & Eye','Tie','Buckle','Velcro','None'].map(c=>`<option ${c===d.closure?'selected':''}>${c}</option>`).join('')}
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Fit</div>
        <div class="spec-v"><select class="spec-sel" id="sp-fit">
          ${['Regular Fit','Slim Fit','Relaxed','Oversized','Athletic Fit','Classic','Tailored','Loose'].map(f=>`<option ${f===d.fit?'selected':''}>${f}</option>`).join('')}
        </select></div>
        <div class="spec-k r2">Occasion</div>
        <div class="spec-v"><select class="spec-sel" id="sp-occasion">
          ${['Casual','Formal','Business','Active/Athletic','Special Occasion','Outdoor','Everyday','Lounge'].map(o=>`<option ${o===d.occasion?'selected':''}>${o}</option>`).join('')}
        </select></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">Season</div>
        <div class="spec-v"><select class="spec-sel" id="sp-season">
          ${['All Seasons','Spring','Summer','Fall','Winter','Spring/Summer','Fall/Winter'].map(s=>`<option ${s===d.season?'selected':''}>${s}</option>`).join('')}
        </select></div>
        <div class="spec-k r2">Lining</div>
        <div class="spec-v"><input class="spec-inp" id="sp-lining" value="${d.lining}" /></div>
      </div>

      <div class="spec-row">
        <div class="spec-k">SKU</div>
        <div class="spec-v"><input class="spec-inp" id="sp-sku" value="${genSku(d)}" /></div>
        <div class="spec-k r2">Category ID</div>
        <div class="spec-v"><input class="spec-inp" id="sp-catid" value="${d.cat_id}" /></div>
      </div>

    </div>

    <!-- MEASUREMENTS -->
    <div class="lbl" style="margin:12px 0 8px">Measurements (inches)
      <span style="color:var(--t3);font-size:8px;letter-spacing:.04em"> ¬∑ Flat lay ¬∑ Enter values for eBay description</span>
    </div>
    <div class="specs-wrap" style="margin-bottom:12px">
      <div class="spec-row">
        <div class="spec-k">Chest</div>
        <div class="spec-v"><input class="spec-inp" id="m-chest" placeholder="pit to pit" /></div>
        <div class="spec-k r2">Length</div>
        <div class="spec-v"><input class="spec-inp" id="m-length" placeholder="top to hem" /></div>
      </div>
      <div class="spec-row">
        <div class="spec-k">Sleeve</div>
        <div class="spec-v"><input class="spec-inp" id="m-sleeve" placeholder="shoulder to cuff" /></div>
        <div class="spec-k r2">Shoulder</div>
        <div class="spec-v"><input class="spec-inp" id="m-shoulder" placeholder="seam to seam" /></div>
      </div>
      <div class="spec-row">
        <div class="spec-k">Waist</div>
        <div class="spec-v"><input class="spec-inp" id="m-waist" placeholder="for pants/skirts" /></div>
        <div class="spec-k r2">Inseam</div>
        <div class="spec-v"><input class="spec-inp" id="m-inseam" placeholder="for pants" /></div>
      </div>
    </div>

    <!-- FEATURES -->
    <div class="lbl" style="margin-bottom:7px">Features</div>
    <textarea class="f-text" id="features-area" rows="2" placeholder="Notable design details">${(d.features||[]).join(', ')}</textarea>

    <!-- CARE -->
    <div class="lbl" style="margin:8px 0 7px">Care Instructions</div>
    <input class="f-text" id="care-area" value="${d.care_instructions||''}" placeholder="From care label" />

    <!-- DESCRIPTION -->
    <div class="lbl" style="margin:8px 0 7px">Description</div>
    <textarea class="f-text" id="desc-area" rows="5">${d.desc}</textarea>

  </div>`;

  // Update publish preview
  document.getElementById('pub-preview').innerHTML = `
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">${title}</div>
    <div>Brand: <b>${d.brand}</b> ¬∑ Size: ${d.size} ¬∑ Color: ${d.color} ¬∑ Condition: ${d.cond_label} ¬∑ Price: <span style="color:var(--amber)">$${d.price_rec}</span></div>
  `;

  // Load market comps
  loadComps(d);
}

function upChars(el) {
  const n = el.value.length;
  const s = document.getElementById('cc');
  s.textContent = n;
  s.style.color = n>80?'var(--red)':n>70?'var(--amber)':'var(--green)';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PUBLISH ‚Äî real API call
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function publish() {
  if (!analysisData) { alert('Run analysis first.'); return; }
  const b = document.getElementById('pbtn');
  b.innerHTML='<span class="spin">‚óå</span>  Uploading photos & publishing...'; b.disabled=true;
  try {
    const policies = JSON.parse(localStorage.getItem('apoc2_policies') || '{}');
    const body = {
      title:       document.getElementById('ttl')?.value || analysisData.title,
      description: document.getElementById('desc-area')?.value || analysisData.desc,
      ship_id:     policies.ship || '',
      ret_id:      policies.ret  || '',
      postal:      document.getElementById('zip-inp')?.value || '10001',
      duration:    document.getElementById('list-dur')?.value || 'GTC',
      dispatch:    document.getElementById('dispatch')?.value || '3',
      brand:       document.getElementById('sp-brand')?.value || '',
      gender:      document.getElementById('sp-dept')?.value || '',
      size:        document.getElementById('sp-size')?.value || '',
      size_type:   document.getElementById('sp-sizetype')?.value || '',
      color:       document.getElementById('sp-color')?.value || '',
      color_std:   document.getElementById('sp-colormap')?.value || '',
      material:    document.getElementById('sp-material')?.value || '',
      sleeve_length: document.getElementById('sp-sleeve')?.value || '',
      neckline:    document.getElementById('sp-neckline')?.value || '',
      style_details: (document.getElementById('sp-style')?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      category:    document.getElementById('sp-type')?.value || '',
      origin:      document.getElementById('sp-origin')?.value || '',
      vintage:     document.getElementById('sp-vintage')?.value === 'Yes',
      tags_present: document.getElementById('sp-nwt')?.value === 'Yes',
      cat_id:      document.getElementById('sp-catid')?.value || '',
      pattern:     document.getElementById('sp-pattern')?.value || '',
      closure:     document.getElementById('sp-closure')?.value || '',
      fit:         document.getElementById('sp-fit')?.value || '',
      occasion:    document.getElementById('sp-occasion')?.value || '',
      season:      document.getElementById('sp-season')?.value || '',
      lining_material: document.getElementById('sp-lining')?.value || '',
      sku:         document.getElementById('sp-sku')?.value || '',
      features:    (document.getElementById('features-area')?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      care_instructions: document.getElementById('care-area')?.value || '',
      m_chest:     document.getElementById('m-chest')?.value || '',
      m_length:    document.getElementById('m-length')?.value || '',
      m_sleeve:    document.getElementById('m-sleeve')?.value || '',
      m_shoulder:  document.getElementById('m-shoulder')?.value || '',
      m_waist:     document.getElementById('m-waist')?.value || '',
      m_inseam:    document.getElementById('m-inseam')?.value || '',
      listing_format: document.getElementById('list-fmt')?.value || 'FixedPriceItem',
      start_price:    document.getElementById('price-inp')?.value || '',
      buy_now_price:  document.getElementById('bin-price-inp')?.value || '',
      best_offer:     document.getElementById('best-offer-chk')?.checked || false,
      min_offer:      document.getElementById('min-offer-inp')?.value || '',
    };
    const resp = await fetch(`${API}/publish`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body),
    });
    const result = await resp.json();
    const r = document.getElementById('pres');
    if (result.success) {
      r.className='pub-res ok';
      r.innerHTML=`‚úì Listed successfully\nItem ID: ${result.item_id}\n${result.url}`;
      b.innerHTML='List Another ‚Üí'; b.disabled=false;
      b.onclick = listAnother;
    } else {
      r.className='pub-res er';
      r.textContent='‚úó ' + (result.error || 'Publish failed');
      b.innerHTML='Publish Listing to eBay ‚Üí'; b.disabled=false;
    }
  } catch(err) {
    b.innerHTML='Publish Listing to eBay ‚Üí'; b.disabled=false;
    const r = document.getElementById('pres');
    r.className='pub-res er';
    r.textContent='‚úó Network error: ' + err.message;
  }
}

function listAnother() {
  files = [];
  analysisData = null;
  renderDZ();
  document.getElementById('fi').value = '';
  document.getElementById('s1').className = 'card active';
  document.getElementById('s2').className = 'card';
  document.getElementById('s3').className = 'card';
  document.getElementById('s2body').innerHTML =
    '<div style="text-align:center;padding:20px 0;font-family:\'DM Mono\',monospace;font-size:11px;color:var(--t3)">Upload photos then run analysis</div>';
  document.getElementById('pub-preview').innerHTML = 'Complete analysis above to see listing preview.';
  document.getElementById('pres').className = 'pub-res';
  document.getElementById('pres').textContent = '';
  const abtn = document.getElementById('abtn');
  abtn.disabled = false; abtn.innerHTML = 'Analyze Garment ‚Üí';
  const pbtn = document.getElementById('pbtn');
  pbtn.disabled = false; pbtn.innerHTML = 'Publish Listing to eBay ‚Üí';
  pbtn.onclick = function(){ publish(); };
  const bg = document.getElementById('bg-btn');
  bg.innerHTML = 'Remove Background'; bg.style.color = ''; bg.style.borderColor = '';
  document.getElementById('price-inp').value = '';
  document.getElementById('bin-price-inp').value = '';
  document.getElementById('best-offer-chk').checked = false;
  document.getElementById('min-offer-inp').value = '';
  onOfferToggle();
  // Clear measurements
  ['m-chest','m-length','m-sleeve','m-shoulder','m-waist','m-inseam'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
loadSaved();
detectZip();
</script>
</body>
</html>
