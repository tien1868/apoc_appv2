<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>APOC² — Inventory Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0d0f12;--surf:#13161b;--surf2:#191c22;--surf3:#1f232b;
  --bdr:rgba(255,255,255,0.07);--bdr-h:rgba(255,255,255,0.12);
  --amber:#e8924a;--amber-d:rgba(232,146,74,0.14);--amber-b:rgba(232,146,74,0.28);
  --green:#3ecf8e;--green-d:rgba(62,207,142,0.12);--green-b:rgba(62,207,142,0.28);
  --red:#e05c5c;--red-d:rgba(224,92,92,0.12);
  --blue:#5b9cf6;--blue-d:rgba(91,156,246,0.12);
  --text:#e8e5e0;--t2:#7a7875;--t3:#3d3c3a;
  --r:8px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;min-height:100vh}

.hdr{padding:16px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr)}
.hdr h1{font-size:18px;font-weight:800;letter-spacing:-.02em}
.hdr h1 sup{font-size:10px;color:var(--amber)}
.hdr a{font-family:'DM Mono',monospace;font-size:11px;color:var(--amber);text-decoration:none;border:1px solid var(--amber-b);padding:5px 12px;border-radius:4px}
.hdr a:hover{background:var(--amber-d)}

.stats{display:flex;gap:12px;padding:16px 24px;flex-wrap:wrap}
.stat{flex:1;min-width:120px;padding:14px 16px;background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r)}
.stat-val{font-family:'DM Mono',monospace;font-size:22px;font-weight:700;color:var(--amber)}
.stat-lbl{font-family:'DM Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--t2);margin-top:4px}

.toolbar{display:flex;gap:10px;padding:8px 24px 16px;flex-wrap:wrap;align-items:center}
.search-inp{flex:1;min-width:200px;padding:8px 14px;background:var(--surf2);border:1px solid var(--bdr-h);border-radius:var(--r);color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none}
.search-inp:focus{border-color:var(--amber-b)}
.filter-btn{padding:6px 12px;background:var(--surf2);border:1px solid var(--bdr-h);border-radius:var(--r);color:var(--t2);font-family:'DM Mono',monospace;font-size:10px;cursor:pointer;text-transform:uppercase;letter-spacing:.08em}
.filter-btn.active{border-color:var(--amber-b);color:var(--amber);background:var(--amber-d)}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;padding:0 24px 24px}
.item{background:var(--surf);border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;transition:border-color .15s}
.item:hover{border-color:var(--bdr-h)}
.item-top{display:flex;gap:12px;padding:14px}
.item-thumb{width:64px;height:64px;border-radius:6px;background:var(--surf3);flex-shrink:0;object-fit:cover}
.item-info{flex:1;min-width:0}
.item-title{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.item-meta{font-family:'DM Mono',monospace;font-size:10px;color:var(--t2);margin-top:3px}
.item-price{font-family:'DM Mono',monospace;font-size:14px;color:var(--amber);font-weight:700;margin-top:2px}
.item-platforms{display:flex;flex-wrap:wrap;gap:4px;padding:0 14px 10px}
.p-badge{font-family:'DM Mono',monospace;font-size:9px;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.06em}
.p-badge.active{background:var(--green-d);border:1px solid var(--green-b);color:var(--green)}
.p-badge.sold{background:var(--amber-d);border:1px solid var(--amber-b);color:var(--amber)}
.p-badge.delisted{background:var(--surf3);border:1px solid var(--bdr);color:var(--t3)}
.item-actions{display:flex;gap:6px;padding:8px 14px;border-top:1px solid var(--bdr);background:var(--surf2)}
.act-btn{flex:1;padding:6px 0;text-align:center;font-family:'DM Mono',monospace;font-size:10px;border-radius:4px;border:1px solid var(--bdr-h);background:transparent;color:var(--t2);cursor:pointer;transition:all .15s}
.act-btn:hover{border-color:var(--amber-b);color:var(--amber)}
.act-btn.danger:hover{border-color:rgba(224,92,92,.4);color:var(--red)}
.act-btn.sold-btn{border-color:var(--green-b);color:var(--green);background:var(--green-d)}

.empty{text-align:center;padding:60px 24px;font-family:'DM Mono',monospace;font-size:12px;color:var(--t3)}

/* Sold modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal-bg.show{display:flex}
.modal{background:var(--surf);border:1px solid var(--bdr-h);border-radius:12px;padding:24px;min-width:320px;max-width:420px}
.modal h3{font-size:15px;margin-bottom:14px}
.modal-plats{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.modal-plat{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surf2);border:1px solid var(--bdr);border-radius:var(--r);cursor:pointer;transition:all .15s}
.modal-plat:hover{border-color:var(--amber-b)}
.modal-plat .dot{width:10px;height:10px;border-radius:50%}
.modal-cancel{padding:8px 16px;border:1px solid var(--bdr-h);background:transparent;color:var(--t2);font-family:'DM Mono',monospace;font-size:11px;border-radius:var(--r);cursor:pointer;width:100%}
</style>
</head>
<body>

<div class="hdr">
  <h1>APOC<sup>2</sup> Inventory</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <a href="index.html">+ New Listing</a>
    <a href="bulk.html">Bulk Upload</a>
  </div>
</div>

<div class="stats" id="stats-bar"></div>

<div class="toolbar">
  <input class="search-inp" id="search" placeholder="Search by title, brand..." oninput="renderItems()"/>
  <button class="filter-btn active" data-filter="all" onclick="setFilter('all',this)">All</button>
  <button class="filter-btn" data-filter="active" onclick="setFilter('active',this)">Active</button>
  <button class="filter-btn" data-filter="sold" onclick="setFilter('sold',this)">Sold</button>
</div>

<div class="grid" id="grid"></div>

<div class="modal-bg" id="sold-modal">
  <div class="modal">
    <h3>Where did it sell?</h3>
    <div class="modal-plats" id="modal-plats"></div>
    <button class="modal-cancel" onclick="closeSoldModal()">Cancel</button>
  </div>
</div>

<script>
const API = localStorage.getItem('apoc2_api') || 'https://pm9d3cd2bq.us-east-1.awsapprunner.com';
const PLAT_COLORS = {ebay:'#5b9cf6',poshmark:'#e05c5c',mercari:'#e8924a',depop:'#3ecf8e',facebook:'#5b9cf6'};
let currentFilter = 'all';
let soldItemId = null;

function getInventory() {
  return JSON.parse(localStorage.getItem('apoc2_inventory') || '[]');
}
function saveInventory(inv) {
  localStorage.setItem('apoc2_inventory', JSON.stringify(inv));
}

function renderStats() {
  const inv = getInventory();
  const active = inv.filter(i => !i.sold_on);
  const sold = inv.filter(i => i.sold_on);
  const totalValue = active.reduce((s, i) => s + (i.price || 0), 0);
  const platCounts = {};
  active.forEach(i => {
    Object.keys(i.platforms || {}).forEach(p => {
      if (i.platforms[p].status === 'active') platCounts[p] = (platCounts[p] || 0) + 1;
    });
  });
  document.getElementById('stats-bar').innerHTML = `
    <div class="stat"><div class="stat-val">${inv.length}</div><div class="stat-lbl">Total Items</div></div>
    <div class="stat"><div class="stat-val">${active.length}</div><div class="stat-lbl">Active</div></div>
    <div class="stat"><div class="stat-val">${sold.length}</div><div class="stat-lbl">Sold</div></div>
    <div class="stat"><div class="stat-val">$${totalValue.toFixed(0)}</div><div class="stat-lbl">Active Value</div></div>
    ${Object.entries(platCounts).map(([p,c]) => `<div class="stat"><div class="stat-val" style="color:${PLAT_COLORS[p]||'var(--amber)'}">${c}</div><div class="stat-lbl">${p}</div></div>`).join('')}
  `;
}

function renderItems() {
  const inv = getInventory();
  const q = document.getElementById('search').value.toLowerCase();
  let items = inv.filter(i => {
    if (q && !(`${i.title} ${i.brand} ${i.size}`).toLowerCase().includes(q)) return false;
    if (currentFilter === 'active' && i.sold_on) return false;
    if (currentFilter === 'sold' && !i.sold_on) return false;
    return true;
  });
  // Sort newest first
  items.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
  const grid = document.getElementById('grid');
  if (!items.length) {
    grid.innerHTML = `<div class="empty" style="grid-column:1/-1">${inv.length ? 'No matching items.' : 'No items yet. Publish a listing to get started.'}</div>`;
    return;
  }
  grid.innerHTML = items.map(item => {
    const platBadges = Object.entries(item.platforms || {}).map(([p, info]) => {
      const cls = item.sold_on ? (p === item.sold_on ? 'sold' : 'delisted') : 'active';
      return `<span class="p-badge ${cls}" style="${cls==='active'?`border-color:${PLAT_COLORS[p]};color:${PLAT_COLORS[p]};background:color-mix(in srgb,${PLAT_COLORS[p]} 12%,transparent)`:''}">${p}${info.item_id ? ' #'+info.item_id : ''}</span>`;
    }).join('');
    const date = new Date(item.created_at).toLocaleDateString();
    const thumb = item.image_thumb ? `<img class="item-thumb" src="${item.image_thumb}" alt=""/>` : `<div class="item-thumb"></div>`;
    const ebayUrl = item.platforms?.ebay?.url;
    return `<div class="item">
      <div class="item-top">
        ${thumb}
        <div class="item-info">
          <div class="item-title">${item.title || 'Untitled'}</div>
          <div class="item-meta">${item.brand || ''} · ${item.size || ''} · ${date}</div>
          <div class="item-price">$${(item.price||0).toFixed(2)}</div>
        </div>
      </div>
      <div class="item-platforms">${platBadges}</div>
      <div class="item-actions">
        ${item.sold_on
          ? `<button class="act-btn sold-btn" disabled>Sold on ${item.sold_on}</button>`
          : `<button class="act-btn" onclick="openSoldModal('${item.id}')">Mark Sold</button>`}
        ${ebayUrl ? `<button class="act-btn" onclick="window.open('${ebayUrl}','_blank')">View on eBay</button>` : ''}
        <button class="act-btn danger" onclick="removeItem('${item.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderItems();
}

function openSoldModal(itemId) {
  soldItemId = itemId;
  const inv = getInventory();
  const item = inv.find(i => i.id === itemId);
  if (!item) return;
  const plats = Object.keys(item.platforms || {});
  document.getElementById('modal-plats').innerHTML = plats.map(p =>
    `<div class="modal-plat" onclick="markSold('${p}')">
      <div class="dot" style="background:${PLAT_COLORS[p]||'var(--amber)'}"></div>
      <span style="font-family:'DM Mono',monospace;font-size:12px">${p.charAt(0).toUpperCase()+p.slice(1)}</span>
    </div>`
  ).join('');
  document.getElementById('sold-modal').classList.add('show');
}

function closeSoldModal() {
  document.getElementById('sold-modal').classList.remove('show');
  soldItemId = null;
}

async function markSold(platform) {
  closeSoldModal();
  const inv = getInventory();
  const item = inv.find(i => i.id === soldItemId);
  if (!item) return;
  item.sold_on = platform;
  item.sold_at = new Date().toISOString();
  // Auto-delist from eBay if sold elsewhere
  if (platform !== 'ebay' && item.platforms.ebay && item.platforms.ebay.item_id) {
    const token = localStorage.getItem('apoc2_ebay_access');
    if (token) {
      try {
        const resp = await fetch(`${API}/delist`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ item_id: item.platforms.ebay.item_id, ebay_token: token }),
        });
        const result = await resp.json();
        if (result.success) {
          item.platforms.ebay.status = 'delisted';
          alert(`eBay listing #${item.platforms.ebay.item_id} has been delisted.`);
        } else {
          alert(`Could not delist from eBay: ${result.error}\nPlease delist manually.`);
        }
      } catch (err) {
        alert('Could not reach server to delist from eBay. Please delist manually.');
      }
    }
  }
  // Mark all platforms as sold/delisted
  Object.keys(item.platforms).forEach(p => {
    item.platforms[p].status = p === platform ? 'sold' : 'delisted';
  });
  // Remind about manual delisting
  const manualDelist = Object.keys(item.platforms).filter(p => p !== 'ebay' && p !== platform && item.platforms[p].status === 'delisted');
  if (manualDelist.length) {
    alert(`Don't forget to delist from: ${manualDelist.join(', ')}`);
  }
  saveInventory(inv);
  renderStats();
  renderItems();
}

function removeItem(itemId) {
  if (!confirm('Remove this item from inventory?')) return;
  const inv = getInventory().filter(i => i.id !== itemId);
  saveInventory(inv);
  renderStats();
  renderItems();
}

// Init
renderStats();
renderItems();
</script>
</body>
</html>
